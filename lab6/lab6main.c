/*
 * test program for Lab 6.
 */

#include <c8051f120.h>          // get SFR declarations
#include "dac.h"

void kbinit ( void );
uint8 kbcheck ( void );

void dacinit ( void );
uint8 dacbusy ( void );
void dacplay(uint16 count, uint8 xdata *buffer);

uint16 toggle(void);
uint8 toggle_stereo(void);

uint8 xdata sinewave[][480] = {
  {
     0xff,0xff,0xfe,0xfe,0xfd,0xfe,0xfb,0xfd,0xf8,0xfc,0xf5,0xfa,
     0xf1,0xf8,0xec,0xf6,0xe6,0xf3,0xe0,0xf1,0xd9,0xed,0xd2,0xea,
     0xca,0xe6,0xc2,0xe2,0xb9,0xde,0xb0,0xd9,0xa6,0xd4,0x9d,0xcf,
     0x93,0xca,0x89,0xc4,0x7f,0xbf,0x75,0xb9,0x6b,0xb3,0x61,0xad,
     0x58,0xa6,0x4e,0xa0,0x45,0x9a,0x3c,0x93,0x34,0x8c,0x2c,0x86,
     0x25,0x7f,0x1e,0x78,0x18,0x72,0x12,0x6b,0x0d,0x64,0x09,0x5e,
     0x06,0x58,0x03,0x51,0x01,0x4b,0x00,0x45,0x00,0x3f,0x00,0x3a,
     0x01,0x34,0x03,0x2f,0x06,0x2a,0x09,0x25,0x0d,0x20,0x12,0x1c,
     0x18,0x18,0x1e,0x14,0x25,0x11,0x2c,0x0d,0x34,0x0b,0x3c,0x08,
     0x45,0x06,0x4e,0x04,0x58,0x02,0x61,0x01,0x6b,0x00,0x75,0x00,
     0x7f,0x00,0x89,0x00,0x93,0x00,0x9d,0x01,0xa6,0x02,0xb0,0x04,
     0xb9,0x06,0xc2,0x08,0xca,0x0b,0xd2,0x0d,0xd9,0x11,0xe0,0x14,
     0xe6,0x18,0xec,0x1c,0xf1,0x20,0xf5,0x25,0xf8,0x2a,0xfb,0x2f,
     0xfd,0x34,0xfe,0x3a,0xff,0x3f,0xfe,0x45,0xfd,0x4b,0xfb,0x51,
     0xf8,0x58,0xf5,0x5e,0xf1,0x64,0xec,0x6b,0xe6,0x72,0xe0,0x78,
     0xd9,0x7f,0xd2,0x86,0xca,0x8c,0xc2,0x93,0xb9,0x9a,0xb0,0xa0,
     0xa6,0xa6,0x9d,0xad,0x93,0xb3,0x89,0xb9,0x7f,0xbf,0x75,0xc4,
     0x6b,0xca,0x61,0xcf,0x58,0xd4,0x4e,0xd9,0x45,0xde,0x3c,0xe2,
     0x34,0xe6,0x2c,0xea,0x25,0xed,0x1e,0xf1,0x18,0xf3,0x12,0xf6,
     0x0d,0xf8,0x09,0xfa,0x06,0xfc,0x03,0xfd,0x01,0xfe,0x00,0xfe,
     0x00,0xff,0x00,0xfe,0x01,0xfe,0x03,0xfd,0x06,0xfc,0x09,0xfa,
     0x0d,0xf8,0x12,0xf6,0x18,0xf3,0x1e,0xf1,0x25,0xed,0x2c,0xea,
     0x34,0xe6,0x3c,0xe2,0x45,0xde,0x4e,0xd9,0x58,0xd4,0x61,0xcf,
     0x6b,0xca,0x75,0xc4,0x7f,0xbf,0x89,0xb9,0x93,0xb3,0x9d,0xad,
     0xa6,0xa6,0xb0,0xa0,0xb9,0x9a,0xc2,0x93,0xca,0x8c,0xd2,0x86,
     0xd9,0x7f,0xe0,0x78,0xe6,0x72,0xec,0x6b,0xf1,0x64,0xf5,0x5e,
     0xf8,0x58,0xfb,0x51,0xfd,0x4b,0xfe,0x45,0xff,0x3f,0xfe,0x3a,
     0xfd,0x34,0xfb,0x2f,0xf8,0x2a,0xf5,0x25,0xf1,0x20,0xec,0x1c,
     0xe6,0x18,0xe0,0x14,0xd9,0x11,0xd2,0x0d,0xca,0x0b,0xc2,0x08,
     0xb9,0x06,0xb0,0x04,0xa6,0x02,0x9d,0x01,0x93,0x00,0x89,0x00,
     0x7f,0x00,0x75,0x00,0x6b,0x00,0x61,0x01,0x58,0x02,0x4e,0x04,
     0x45,0x06,0x3c,0x08,0x34,0x0b,0x2c,0x0d,0x25,0x11,0x1e,0x14,
     0x18,0x18,0x12,0x1c,0x0d,0x20,0x09,0x25,0x06,0x2a,0x03,0x2f,
     0x01,0x34,0x00,0x3a,0x00,0x3f,0x00,0x45,0x01,0x4b,0x03,0x51,
     0x06,0x58,0x09,0x5e,0x0d,0x64,0x12,0x6b,0x18,0x72,0x1e,0x78,
     0x25,0x7f,0x2c,0x86,0x34,0x8c,0x3c,0x93,0x45,0x9a,0x4e,0xa0,
     0x58,0xa6,0x61,0xad,0x6b,0xb3,0x75,0xb9,0x7f,0xbf,0x89,0xc4,
     0x93,0xca,0x9d,0xcf,0xa6,0xd4,0xb0,0xd9,0xb9,0xde,0xc2,0xe2,
     0xca,0xe6,0xd2,0xea,0xd9,0xed,0xe0,0xf1,0xe6,0xf3,0xec,0xf6,
     0xf1,0xf8,0xf5,0xfa,0xf8,0xfc,0xfb,0xfd,0xfd,0xfe,0xfe,0xfe,
  },
#if 1
  {
     0xff,0xff,0xfe,0xfd,0xfc,0xfa,0xf8,0xf5,0xf3,0xed,0xed,0xe4,
     0xe6,0xd9,0xde,0xcd,0xd4,0xbf,0xca,0xb0,0xbf,0xa0,0xb3,0x90,
     0xa6,0x7f,0x9a,0x6e,0x8c,0x5e,0x7f,0x4e,0x72,0x3f,0x64,0x31,
     0x58,0x25,0x4b,0x1a,0x3f,0x11,0x34,0x09,0x2a,0x04,0x20,0x01,
     0x18,0x00,0x11,0x01,0x0b,0x04,0x06,0x09,0x02,0x11,0x00,0x1a,
     0x00,0x25,0x00,0x31,0x02,0x3f,0x06,0x4e,0x0b,0x5e,0x11,0x6e,
     0x18,0x7f,0x20,0x90,0x2a,0xa0,0x34,0xb0,0x3f,0xbf,0x4b,0xcd,
     0x58,0xd9,0x64,0xe4,0x72,0xed,0x7f,0xf5,0x8c,0xfa,0x9a,0xfd,
     0xa6,0xff,0xb3,0xfd,0xbf,0xfa,0xca,0xf5,0xd4,0xed,0xde,0xe4,
     0xe6,0xd9,0xed,0xcd,0xf3,0xbf,0xf8,0xb0,0xfc,0xa0,0xfe,0x90,
     0xff,0x7f,0xfe,0x6e,0xfc,0x5e,0xf8,0x4e,0xf3,0x3f,0xed,0x31,
     0xe6,0x25,0xde,0x1a,0xd4,0x11,0xca,0x09,0xbf,0x04,0xb3,0x01,
     0xa6,0x00,0x9a,0x01,0x8c,0x04,0x7f,0x09,0x72,0x11,0x64,0x1a,
     0x58,0x25,0x4b,0x31,0x3f,0x3f,0x34,0x4e,0x2a,0x5e,0x20,0x6e,
     0x18,0x7f,0x11,0x90,0x0b,0xa0,0x06,0xb0,0x02,0xbf,0x00,0xcd,
     0x00,0xd9,0x00,0xe4,0x02,0xed,0x06,0xf5,0x0b,0xfa,0x11,0xfd,
     0x18,0xff,0x20,0xfd,0x2a,0xfa,0x34,0xf5,0x3f,0xed,0x4b,0xe4,
     0x58,0xd9,0x64,0xcd,0x72,0xbf,0x7f,0xb0,0x8c,0xa0,0x9a,0x90,
     0xa6,0x7f,0xb3,0x6e,0xbf,0x5e,0xca,0x4e,0xd4,0x3f,0xde,0x31,
     0xe6,0x25,0xed,0x1a,0xf3,0x11,0xf8,0x09,0xfc,0x04,0xfe,0x01,
     0xff,0x00,0xfe,0x01,0xfc,0x04,0xf8,0x09,0xf3,0x11,0xed,0x1a,
     0xe6,0x25,0xde,0x31,0xd4,0x3f,0xca,0x4e,0xbf,0x5e,0xb3,0x6e,
     0xa6,0x7f,0x9a,0x90,0x8c,0xa0,0x7f,0xb0,0x72,0xbf,0x64,0xcd,
     0x58,0xd9,0x4b,0xe4,0x3f,0xed,0x34,0xf5,0x2a,0xfa,0x20,0xfd,
     0x18,0xff,0x11,0xfd,0x0b,0xfa,0x06,0xf5,0x02,0xed,0x00,0xe4,
     0x00,0xd9,0x00,0xcd,0x02,0xbf,0x06,0xb0,0x0b,0xa0,0x11,0x90,
     0x18,0x7f,0x20,0x6e,0x2a,0x5e,0x34,0x4e,0x3f,0x3f,0x4b,0x31,
     0x58,0x25,0x64,0x1a,0x72,0x11,0x7f,0x09,0x8c,0x04,0x9a,0x01,
     0xa6,0x00,0xb3,0x01,0xbf,0x04,0xca,0x09,0xd4,0x11,0xde,0x1a,
     0xe6,0x25,0xed,0x31,0xf3,0x3f,0xf8,0x4e,0xfc,0x5e,0xfe,0x6e,
     0xff,0x7f,0xfe,0x90,0xfc,0xa0,0xf8,0xb0,0xf3,0xbf,0xed,0xcd,
     0xe6,0xd9,0xde,0xe4,0xd4,0xed,0xca,0xf5,0xbf,0xfa,0xb3,0xfd,
     0xa6,0xff,0x9a,0xfd,0x8c,0xfa,0x7f,0xf5,0x72,0xed,0x64,0xe4,
     0x58,0xd9,0x4b,0xcd,0x3f,0xbf,0x34,0xb0,0x2a,0xa0,0x20,0x90,
     0x18,0x7f,0x11,0x6e,0x0b,0x5e,0x06,0x4e,0x02,0x3f,0x00,0x31,
     0x00,0x25,0x00,0x1a,0x02,0x11,0x06,0x09,0x0b,0x04,0x11,0x01,
     0x18,0x00,0x20,0x01,0x2a,0x04,0x34,0x09,0x3f,0x11,0x4b,0x1a,
     0x58,0x25,0x64,0x31,0x72,0x3f,0x7f,0x4e,0x8c,0x5e,0x9a,0x6e,
     0xa6,0x7f,0xb3,0x90,0xbf,0xa0,0xca,0xb0,0xd4,0xbf,0xde,0xcd,
     0xe6,0xd9,0xed,0xe4,0xf3,0xed,0xf8,0xf5,0xfc,0xfa,0xfe,0xfd,
  }
#endif
};

void main (void) {
  uint8 wave = 0;

  WDTCN = 0xde;                 /* disable watchdog timer */
  WDTCN = 0xad;
  SFRPAGE = CONFIG_PAGE;
                                /* set up Crossbar and GPIO */
  XBR2 = 0x40;                  /* Enable crossbar and weak pull-ups */
                                /* need to enable Port 1 pins for output */
  XBR0 = 0x03;                  /* Enable SPI and SMBus on crossbar */
  OSCICN = 0xc2;
  SFRPAGE = 0;                  /* Put SPI into three-wire mode */
  SPI0CFG = 0x40;
  NSSMD1 = NSSMD0 = 0;

  kbinit ();
  dacinit ();
  dac2init();
  dacrate(toggle());
  dacstereo(toggle_stereo());

  EA = 1;                       /* Enable all interrupts */

  dacplay(240*2, sinewave[wave]);
  while (1) {
    PCON |= 1;
    if ( ! dacbusy() ) {
      dacplay(240*2, sinewave[wave]);
    }
    switch ( kbcheck() ) {
    case '1':
    case '!':
      wave = 0;
      break;
    case '2':
    case '@':
      wave = 1;
      break;
    case 't':
    case 'T':
      wave = 1 - wave;
      break;
    case '<':
    case ',':
      dacbalance(1);
      break;
    case '>':
    case '.':
      dacbalance(-1);
      break;
    case 'u':
    case 'U':
      dacvolume(1);
      break;
    case 'd':
    case 'D':
      dacvolume(-1);
      break;
    case 'r':
    case 'R':
      dacrate(toggle());
      break;
    case 'c':
    case 'C':
      dacstereo(toggle_stereo());
      break;
    default:
      break;
    }
  }
}

uint16 toggle(void){
  static uint8 state = 0;
  switch (state){
    case 0:
      state = (state + 1) % 3;
      return 8000;
    case 1:
      state = (state + 1) % 3;
      return 11025;
    case 2:
      state = (state + 1) % 3;
      return 22050;
  }
}

uint8 toggle_stereo(void){
  static uint8 state = 0;
  state = (state + 1) % 2;
  return state;
  }
